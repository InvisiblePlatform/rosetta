{{ $path := print "data/opensecrets/" . ".json"}}
<!-- Open Secrets -->
{{ if os.FileExists $path }}
{{ $d := getJSON $path }}
<section id="opensec" class="contentSection">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/charts.css/dist/charts.min.css">
<h2 class="sectionTitle">OpenSecrets</h2>
{{ if isset $d "bill_most_heading" }}
<p class="flavourText"><b>{{ index $d "bill_most_heading" }}</b></p>
<p class="flavourText"><a href='{{ index $d "bill_most_url" }}'>{{ index $d "bill_most_title" }} ({{ index $d "bill_most_code" }})</a></p>
{{ end }}
<div class="scoreText fullBleed"><div>
{{ if isset $d "cycle_year" }}
<p>Data is true of the {{ index $d "cycle_year" }} cycle</p>
{{ if isset $d "contributions_rank" }}<p><b>Contributions Rank:</b> {{ index $d "contributions_rank"}}</p>{{ end }}
{{ if isset $d "contributions_amount" }}<p><b>Contributions Amount:</b> {{ index $d "contributions_amount"}}</p>{{ end }}
{{ if isset $d "lobbying_rank" }}<p><b>Lobbying Rank:</b> {{ index $d "lobbying_rank"}}</p>{{ end }}
<div class="charts">
{{ with index $d "bars"  }}
    {{ if isset . "recipients_of_funds"}}
    <h3>Recipients of Funds</h3>
    <table class="charts-css multiple stacked bar show-heading">
    <tbody>
    <tr>
    {{ range index . "recipients_of_funds" }}
    <td style="--size: calc({{ replace  .percent "%" " " }}/100);">
    <span class="data">{{ .entity }}</span>
    <span class="tooltip">{{ .entity }}<br>
        ({{ .amount }})</span>
    </td>
    {{ end }}
    </tr>
    </tbody>
    </table>
    {{ end }}
    {{ if isset . "sources_of_funds"}}
    <h3>Sources of Funds</h3>
    <table class="charts-css multiple stacked bar" >
    <tbody>
    <tr>
    {{ range index . "sources_of_funds" }}
    <td style="--size: calc({{ replace  .percent "%" " " }}/100);">
    <span class="data">{{ .entity }}</span>
    <span class="tooltip">{{ .entity }} <br>
        ({{ .amount }})</span>
    </td>
    {{ end }}
    </tr>
    </tbody>
    </table>
    {{ end }}
    {{ if isset . "sources_of_funds_to_candidates"}}
    <h3>Sources of Funds to Candidates</h3>
    <table class="charts-css multiple stacked bar">
    <tbody>
    <tr>
    {{ range index . "sources_of_funds_to_candidates" }}
    <td style="--size: calc({{ replace  .percent "%" " " }}/100);">
    <span class="data">{{ .entity }}</span>
    <span class="tooltip">{{ .entity }} <br>
        ({{ .amount }})</span>
    </td>
    {{ end }}
    </tr>
    </tbody>
    </table>
    {{ end }}
{{ end }}
{{ with index $d "charts"  }}

{{ with index . "House"  }}
{{ $year_range := sub (int .latest_year) (int .earliest_year) }}{{ $earlyYear := (int .earliest_year) }}{{ $valuelen := len .Dems.all_years }}{{ $houseDems := .Dems.all_years }}{{ $houseRepubs := .Repubs.all_years }}
{{ $heightThou := math.Ceil (div (index (sort (append $houseDems $houseRepubs) "value" "desc" ) 0) 1000) }}
{{ if (gt $heightThou 0 )}}
<h3>House</h3>
<table class="charts-css line multiple hide-data show-labels show-primary-axis" style="--color-1: blue;--color-2:red;">
<thead>
    <tr>
    <th scope="col">Year</th>
    <th scope="col">Democrats</th>
    <th scope="col">Republicans</th>
    </tr>
</thead>
<tbody>
{{ range (seq $valuelen) }}
{{ $tempLoc := (sub . 1)}}{{ $year := add (mul $tempLoc 4) $earlyYear }}
{{ $extraClass := cond (eq 0 (mod $year 8)) "" $year }}
{{ $pV := cond (eq $tempLoc 0) 0 (sub $tempLoc 1) }}
{{ $cvD := index $houseDems $tempLoc }}
{{ $pvD := index $houseDems $pV }}
{{ $cvDt := (div $cvD (mul $heightThou 1000)) }}
{{ $pvDt := (div $pvD (mul $heightThou 1000)) }}
{{ $cvR := index $houseRepubs $tempLoc }}
{{ $pvR := index $houseRepubs $pV }}
{{ $cvRt := (div $cvR (mul $heightThou 1000)) }}
{{ $pvRt := (div $pvR (mul $heightThou 1000)) }}
<tr>
    <th scope="row">{{ $extraClass }}</th>
    <td style="--start:{{ $pvDt }}; --size: {{ $cvDt }};"><span class="data">{{ index $houseDems $tempLoc }}</span></td>
    <td style="--start:{{ $pvRt }}; --size: {{ $cvRt }};"><span class="data">{{ index $houseRepubs $tempLoc }} </span></td>
</tr>
{{ end }}
</tbody>
</table>
{{ end }}
{{ end }}

{{ with index . "Senate"  }}
{{ $year_range := sub (int .latest_year) (int .earliest_year) }}{{ $earlyYear := (int .earliest_year) }}{{ $valuelen := len .Dems.all_years }}{{ $senateDems := .Dems.all_years }}{{ $senateRepubs := .Repubs.all_years }}
{{ $heightThou := math.Ceil (div (index (sort (append $senateDems $senateRepubs) "value" "desc" ) 0) 1000) }}
{{ if (gt $heightThou 0 )}}
<h3>Senate</h3>
<table class="charts-css line multiple hide-data show-labels show-primary-axis show-data-on-hover" style="--color-1: blue;--color-2:red;">
<thead>
    <tr>
    <th scope="col">Year</th>
    <th scope="col">Democrats</th>
    <th scope="col">Republicans</th>
    </tr>
</thead>
<tbody>
{{ range (seq $valuelen) }}
{{ $tempLoc := (sub . 1)}}{{ $year := add (mul $tempLoc 4) $earlyYear }}
{{ $extraClass := cond (eq 0 (mod $year 8)) "" $year }}
{{ $pV := cond (eq $tempLoc 0) 0 (sub $tempLoc 1) }}
{{ $cvD := index $senateDems $tempLoc }}
{{ $pvD := index $senateDems $pV }}
{{ $cvDt := (div $cvD (mul $heightThou 1000)) }}
{{ $pvDt := (div $pvD (mul $heightThou 1000)) }}
{{ $cvR := index $senateRepubs $tempLoc }}
{{ $pvR := index $senateRepubs $pV }}
{{ $cvRt := (div $cvR (mul $heightThou 1000)) }}
{{ $pvRt := (div $pvR (mul $heightThou 1000)) }}
<tr>
    <th scope="row">{{ $extraClass }}</th>
    <td style="--start:{{ $pvDt }}; --size: {{ $cvDt }};"><span class="data">{{ index $senateDems $tempLoc }}</span></td>
    <td style="--start:{{ $pvRt }}; --size: {{ $cvRt }};"><span class="data">{{ index $senateRepubs $tempLoc }} </span></td>
</tr>
{{ end }}
</tbody>
</table>
{{ end }}
{{ end }}
{{ end }}

{{ end }}
</div>


<a class="source hideInSmall" target="_blank" href="https://www.opensecrets.org/orgs/name/summary?id={{ . }}">OPENSECRETS</a>
</div>
</div>
</section>
{{ end }}
