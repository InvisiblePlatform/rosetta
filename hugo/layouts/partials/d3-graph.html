<style>

.links line {
  stroke: #999;
  stroke-opacity: 0.6;
}

.nodes circle {
  stroke: #fff;
  stroke-width: 1.5px;
  fill: #98FB98;
  filter: drop-shadow(0 0 5px black);
  mix-blend-mode: color-burn;
}

.Q5 {
  fill: orangered!important;
}

</style>
<svg id="key" style="overflow:visible;position:absolute;"></svg>
<svg id="graph" width="1280" height="600" viewBox="0 0 1280 600" style="overflow:visible;transition:0.1s"></svg>
<script type="module">
    import {zoom} from "https://cdn.skypack.dev/d3-zoom@3";
    const handler = zoom();
</script>
<script src="https://d3js.org/d3.v6.min.js"></script>
   <script>
       const zoom = d3.zoom()
            .scaleExtent([1, 40])
            .on("zoom", zoomed);

       var svg2 = d3.select("#key");

       var svg = d3.select("#graph").on("click",reset)
       var width = +svg.attr("width");
       var height = +svg.attr("height");

       var simulation = d3.forceSimulation()
           .force("link", d3.forceLink().id(function(d) { return d.id; }).distance(100))
           .force("charge", d3.forceManyBody().strength(-200))
           .force("center", d3.forceCenter(width / 2, height / 2));

       svg.call(zoom);

       function reset() {
          svg.transition().duration(750).call(
            zoom.transform,
            d3.zoomIdentity,
            d3.zoomTransform(svg.node()).invert([width / 2, height / 2])
          );
        }

        function clicked(event, [x, y]) {
          svg.transition().duration(750).call(
            zoom.transform,
            d3.zoomIdentity.translate(width / 2, height / 2).scale(40).translate(-x, -y),
            d3.pointer(event)
          );
        }

        function zoomed({transform}) {
          svg.attr("transform", transform);
        }


       d3.json("{{ . }}").then(function(graph) {
         const types = Array.from(new Set(graph.links.map(d => d.type)));
         var color = d3.scaleOrdinal(types, d3.schemeYlOrRd[types.length]);

         svg.call(d3.zoom()
              .extent([[0, 0], [width, height]])
              .scaleExtent([1, 8])
              .on("zoom", zoomed));

         svg.append("defs").selectAll("marker")
          .data(types).enter()
          .append("marker")
            .attr("id", d => `arrow-${d}`)
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 15)
            .attr("refY", -0.5)
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .attr("orient", "auto")
          .append("path")
               .attr("fill", d => color(d))
            .attr("d", "M0,-5L10,0L0,5");

         var key_y = d3.scaleOrdinal(types,d3.range(0, 15*types.length, 15));

         var key = svg2.append("g")
                .attr("x", 10)
                .attr("y", 50)
               .selectAll("g")
               .data(types).enter()
               .append("g")
               .attr("transform", function(d){ return "translate(0," + key_y(d) + ")"});
         var key_rects = key.append("rect")
           .attr("width", 15)
           .attr("height", 15)
           .attr("fill", color);

        var key_labels = key.append("text")
           .attr("class", "key-text")
               .text(function(d){return d.replace("_"," ");})
            .attr("font-size", "10px")
            .attr("x", 20)
            .attr("y", 15)
            .attr("fill", "black");

         var link = svg.append("g")
           .attr("stroke-width", 1.5)
		   .attr("fill", "none")
           .selectAll("path")
           .data(graph.links)
           .enter().append("path")
		   .attr("stroke", d => color(d.type))
           .attr("marker-end", d => `url(#arrow-${d.type})`);

         var node = svg.append("g")
             .attr("class", "nodes")
             .attr("fill", "currentColor")
             .attr("stroke-linecap", "round")
             .attr("stroke-linejoin", "round")
           .selectAll("g")
           .data(graph.nodes)
           .enter().append("g");

         var lables = node.append("text")
             .attr("class", "label-text")
             .attr("text-anchor", "middle")
               .attr("z-index", function(d){
                   if (d.groups.includes("Q5")){
                        return "100";
                   } else {
                        return "101";
                   }})
               .attr("font-size", function(d){
                   if (d.groups.includes("Q5")){
                        return "6px";
                   } else {
                        return "10px";
                   }})
             .text(function(d) {
                     return d.label;
                   })
             .clone(true).lower()
               .attr("fill", "none")
               .attr("stroke", "white")
               .attr("stroke-width", 3);

           var circles = node.append("a").attr("href", function(d){
               if (d.enwiki != "null"){
                    return "https://en.wikipedia.org/wiki/" + d.enwiki;
               } else {
                    return "https://wikidata.org/wiki/" + d.id;
               }
           }).append("circle")
               .attr("r", function(d){ 
                   if (d.groups.includes("Q5")){
                        return 6;
                   } else {
                        return 10;
                   }
               })
           .attr("class", function(d){ return d.groups.toString().replace(/,/g,' '); });


         // Create a drag handler and append it to the node object instead
         var drag_handler = d3.drag()
             .on("start", dragstarted)
             .on("drag", dragged)
             .on("end", dragended);

         drag_handler(node);
         


         simulation
             .nodes(graph.nodes)
             .on("tick", ticked);

         simulation.force("link")
             .links(graph.links);

         function ticked() {
             link
				.attr("d", linkArc)

             node
                 .attr("transform", function(d) {
                           return "translate(" + d.x + "," + d.y + ")";
                 })
         }
       });

       function dragstarted(event,d) {
         if (!event.active) simulation.alphaTarget(0.3).restart();
         d.fx = d.x;
         d.fy = d.y;
       }

       function dragged(event,d) {
         d.fx = event.x;
         d.fy = event.y;
       }

       function dragended(event,d) {
         if (!event.active) simulation.alphaTarget(0);
         d.fx = null;
         d.fy = null;
       }
	   function linkArc(d) {
	     const r = Math.hypot(d.target.x - d.source.x, d.target.y - d.source.y);
	     return `
		       M${d.source.x},${d.source.y}
		       A${r},${r} 0 0,1 ${d.target.x},${d.target.y}
		     `;
	   }

   </script>
