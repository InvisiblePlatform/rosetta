<div id="wikipedia-frame" style="display:none;"> No content yet </div>
<div id="wikipedia-frame-close" style="display:none;"> Close </div>
<svg id="key" style="overflow:visible;position:absolute;"></svg>
<svg id="graph" style="overflow:visible!important;transition:0.1s"></svg>
<div id="wikipedia-infocard-frame" style="display:none;"> No content yet </div>
<div id="wikipedia-first-frame" style="display:none;"> No content yet </div>
<script type="module">
    import {zoom} from "https://cdn.skypack.dev/d3-zoom@3";
    const handler = zoom();
</script>
<script src="https://d3js.org/d3.v6.min.js"></script>
   <script>
       const zoom = d3.zoom()
            .scaleExtent([-2, 40])
            .on("zoom", zoomed);

       var svg2 = d3.select("#key");
       var docwidth = window.innerWidth - 20;
       var svg = d3.select("#graph").on("click",reset).attr("height", 600).attr("width", docwidth);
       var width = +svg.attr("width");
       var height = +svg.attr("height");
       var wikiframe = document.getElementById("wikipedia-frame");
       var wikiframeclose = document.getElementById("wikipedia-frame-close");
       var wikicardframe = document.getElementById("wikipedia-infocard-frame");
       var wikifirstframe = document.getElementById("wikipedia-first-frame");
       wikiframeclose.onclick = function(){
           wikiframe.style.display = "none";
           wikiframeclose.style.display = "none";
       };

       function getMostCommon(array) {
            var count = {};
            array.forEach(function (a) {
                count[a] = (count[a] || 0) + 1;
            });
            return Object.keys(count).reduce(function (r, k, i) {
                if (!i || count[k] > count[r[0]]) {
                    return [k];
                }
                if (count[k] === count[r[0]]) {
                    r.push(k);
                }
                return r;
            }, []);
        }

       var simulation = d3.forceSimulation()
           .force("link", d3.forceLink().id(function(d) { return d.id; }).distance(50))
           .force("charge", d3.forceManyBody().strength(-400).distanceMax(300))
           .force("center", d3.forceCenter(width / 2, height / 2));

       svg.call(zoom);

       function reset() {
          svg.transition().duration(750).call(
            zoom.transform,
            d3.zoomIdentity,
            d3.zoomTransform(svg.node()).invert([width / 2, height / 2])
          );
        }

        function clicked(event, [x, y]) {
          svg.transition().duration(750).call(
            zoom.transform,
            d3.zoomIdentity.translate(width / 2, height / 2).scale(40).translate(-x, -y),
            d3.pointer(event)
          );
        }

        function zoomed({transform}) {
          svg.attr("transform", transform);
        }

       d3.json("{{ . }}").then(function(graph) {
         const types = Array.from(new Set(graph.links.map(d => d.type)));
         const split = 1 / types.length;
         colors_array=[];
         d3.range(0, 1, split).forEach(function(d){
                colors_array.push(d3.interpolateSinebow(d));
         });
         var color = d3.scaleOrdinal(types, colors_array);

         svg.call(d3.zoom()
              .extent([[0, 0], [width, height]])
              .scaleExtent([1, 8])
              .on("zoom", zoomed));

         svg.append("defs").selectAll("marker")
          .data(types).enter()
          .append("marker")
            .attr("id", d => `arrow-${d}`)
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 15)
            .attr("refY", -0.5)
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .attr("orient", "auto")
          .append("path")
            .attr("fill", d => color(d))
            .attr("d", "M0,-5L10,0L0,5");

         var key_y = d3.scaleOrdinal(types,d3.range(0, 15*types.length, 15));

         var key = svg2.append("g")
                .attr("x", 10)
                .attr("y", 50)
               .selectAll("g")
               .data(types).enter()
               .append("g")
               .attr("transform", function(d){ return "translate(0," + key_y(d) + ")"});
         var key_rects = key.append("rect")
           .attr("width", 15)
           .attr("height", 15)
           .attr("fill", color);

        var key_labels = key.append("text")
           .attr("class", "key-text")
               .text(function(d){return d.replace("_"," ");})
            .attr("font-size", "10px")
            .attr("x", 20)
            .attr("y", 15)
            .attr("fill", "black");


         var urls=[];
         for (var i = document.links.length; i --> 0;)
              if(document.links[i].hostname.match(/wikidata/))
                 urls.push(document.links[i].href)

         var ids=[];
         for (var i = urls.length; i --> 0;)
             ids.push(urls[i].replace(/#.*/g,"").replace(/.*\//,""))
         
         var wikidataid = getMostCommon(ids)[0];
         var link = svg.append("g")
           .attr("stroke-width", 1.5)
		   .attr("fill", "none")
           .selectAll("path")
           .data(graph.links)
           .enter().append("path")
		   .attr("stroke", d => color(d.type))
           .attr("marker-end", d => `url(#arrow-${d.type})`);
         var node = svg.append("g")
             .attr("class", "nodes")
             .attr("fill", "currentColor")
             .attr("stroke-linecap", "round")
             .attr("stroke-linejoin", "round")
           .selectAll("g")
           .data(graph.nodes)
               .enter().append("g").attr("id", function(d){
                   if (d.id == wikidataid){
                        d.fx = width/2;
                        d.fy = height/2;
                   }
                   return d.id;
               });
              var wikichoice;
              switch (localStorage.preferred_language) {
                  case "en":
                    wikichoice = "https://en.wikipedia.org/"
                    console.log("en");
                  break;
                  case "es":
                    wikichoice = "https://es.wikipedia.org/";
                    console.log("es");
                  break;
                  case "eo":
                    wikichoice = "https://eo.wikipedia.org/";
                    console.log("eo");
                  break;
                  default:
                    wikichoice = "https://en.wikipedia.org/";
                    console.log("default");
              }

         if (wikidataid){
              var main = d3.select("#"+wikidataid);
              var wikidataMainWiki;
              switch (localStorage.preferred_language) {
                  case "hi":
                    wikidataMainWiki = main._groups[0][0].__data__.hiwiki;
                    console.log("hi");
                  break;
                  case "zh":
                    wikidataMainWiki = main._groups[0][0].__data__.zhwiki;
                    console.log("zh");
                  break;
                  case "en":
                    wikidataMainWiki = main._groups[0][0].__data__.enwiki;
                    console.log("en");
                  break;
                  case "es":
                    wikidataMainWiki = main._groups[0][0].__data__.eswiki;
                    console.log("es");
                  break;
                  case "eo":
                    wikidataMainWiki = main._groups[0][0].__data__.eowiki;
                    console.log("eo");
                  break;
                  default:
                    wikidataMainWiki = main._groups[0][0].__data__.enwiki;
                    console.log("default");
              }
             if (wikidataMainWiki.includes("wikipedia.org")){
                    wikidataMainWiki = wikidataMainWiki.split('/').slice(4).join("/");
             };
             if (wikidataMainWiki != "null"){
              let requestURL = wikichoice + "api/rest_v1/page/mobile-sections/" + wikidataMainWiki + "?redirect=true"
              $.ajax({
                  url: requestURL
                }).done(function(data) {
                  var text = data.lead.sections[0].text.replace(/href=\"/g,'href=\"' + wikichoice);
                  for (let x in data.remaining.sections) {
                      let section = data.remaining.sections[x];
                      let item = '<p id="'+ section.anchor + '"><h2>'+section.line+'</h2><div>'+section.text.replace(/href=\"/g,'href=\"' + wikichoice)+'</div></p>';
                      text+=item;
                  }
                  wikifirstframe.innerHTML = text;
                  for (var i = wikifirstframe.children.length; i --> 0;)
                    if (wikifirstframe.children[i].classList.contains("infobox")){
                        console.log(wikifirstframe.children[i])
                        wikicardframe.innerHTML = "";
                        wikicardframe.appendChild(wikifirstframe.children[i]);
                    }
                }).fail(function() {
                    console.log("oh no")
              });
              contentsLength = document.getElementsByClassName("content").length;
              lastContent = document.getElementsByClassName("content")[contentsLength - 1];
              lastContent.appendChild(wikifirstframe);
              lastContent.appendChild(wikicardframe);
              if (wikifirstframe.style.display == "none"){
                   wikifirstframe.style.display = "block";
              }
              if (wikicardframe.style.display == "none"){
                   wikicardframe.style.display = "block";
              }
             };

         };


           var circles = node.append("a").attr("href", function(d){
               var wikidataWiki = "";
              switch (localStorage.preferred_language) {
                  case "hi": 
                      wikidataWiki = d.hiwiki;
                  break;
                  case "zh": 
                      wikidataWiki = d.zhwiki;
                  break;
                  case "en": 
                      wikidataWiki = d.enwiki;
                  break;
                  case "de": 
                      wikidataWiki = d.dewiki;
                  break;
                  case "es": 
                      wikidataWiki = d.eswiki;
                  break;
                  case "eo": 
                      wikidataWiki = d.eowiki;
                  break;
                  default: wikidataWiki = d.enwiki;
              };
             if (wikidataWiki.includes("wikipedia.org")){
                    wikidataWiki = wikidataWiki.split('/').slice(4).join("/");
             };
               if (wikidataWiki != "null"){
                    return wikichoice + wikidataWiki;
               } else {
                    return "https://wikidata.org/wiki/" + d.id;
               }
               return "#"
           }).attr("target", "_blank")
               .on('click', function(d,i){
                   var wikidataWiki;
                  switch (localStorage.preferred_language) {
                      case "hi": 
                          wikidataWiki = i.hiwiki;
                      break;
                      case "zh": 
                          wikidataWiki = i.zhwiki;
                      break;
                      case "de": 
                          wikidataWiki = i.dewiki;
                      break;
                      case "en": 
                          wikidataWiki = i.enwiki;
                      break;
                      case "es": 
                          wikidataWiki = i.eswiki;
                      break;
                      case "eo": 
                          wikidataWiki = i.eowiki;
                      break;
                      default: 
                          wikidataWiki = i.enwiki;
                  };
                 if (wikidataWiki.includes("wikipedia.org")){
                        wikidataWiki = wikidataWiki.split('/').slice(4).join("/");
                };
                   if (wikidataWiki == "null"){
                        return
                   }
                   d.preventDefault();
                   console.log("clicking on", this, wikidataWiki);
                   let requestURL = wikichoice + "api/rest_v1/page/mobile-sections/" + wikidataWiki + "?redirect=true"
                   if (wikiframe.style.display == "none"){
                        wikiframe.style.display = "block";
                        wikiframeclose.style.display = "block";
                   }
                   $.ajax({
                       url: requestURL
                     }).done(function(data) {
                       var text = data.lead.sections[0].text.replace(/href=\"/g,'href=\"' + wikichoice);
                       for (let x in data.remaining.sections) {
                           let section = data.remaining.sections[x];
                           let item = '<p id="'+ section.anchor + '"><h2>'+section.line+'</h2><div>'+section.text.replace(/href=\"/g,'href=\"' + wikichoice)+'</div></p>';
                           text+=item;

                       }
                       wikiframe.innerHTML = text;
                     }).fail(function() {
                         console.log("oh no")
                   });

               })
               .append("circle")
               .attr("r", function(d){ 
                    if (d.id == wikidataid){
                        return 20;
                    }
                   if (d.groups.includes("Q5")){
                        return 6;
                   } else {
                        return 10;
                   }
               }).attr("fill", function(d){
                    if (d.id == wikidataid){
                        return "var(--c-linky-text)";
                    }
                   if (d.groups.includes("Q5")){
                        return "var(--c-email-text)";
                   } else {
                        return "var(--c-main)";
                   }
                   return "unset";

               })
           .attr("class", function(d){ return d.groups.toString().replace(/,/g,' '); });

         var lables = node.append("text")
             .attr("class", "label-text")
             .attr("text-anchor", "middle")
               .attr("z-index", function(d){
                   if (d.groups.includes("Q5")){
                        return "100";
                   } else {
                        return "101";
                   }})
               .attr("font-size", function(d){
                   if (d.groups.includes("Q5")){
                        return "6px";
                   } else {
                        return "10px";
                   }})
             .text(function(d) {
                     return d.label;
                   });


         // Create a drag handler and append it to the node object instead
         var drag_handler = d3.drag()
             .on("start", dragstarted)
             .on("drag", dragged);
             // .on("end", dragended);

         drag_handler(node);
         
         simulation
             .nodes(graph.nodes)
             .on("tick", ticked);

         simulation.force("link")
             .links(graph.links);

         function ticked() {
             link.attr("d", linkArc)
             node.attr("transform", function(d) {
                return "translate(" + d.x + "," + d.y + ")";
            })
         }
       });

       function dragstarted(event,d) {
         if (!event.active) simulation.alphaTarget(0.3).restart();
         d.fx = d.x;
         d.fy = d.y;
       }

       function dragged(event,d) {
         d.fx = event.x;
         d.fy = event.y;
         d.fixed = true;
       }

       // function dragended(event,d) {
       //   if (!event.active) simulation.alphaTarget(0);
       //   d.fx = null;
       //   d.fy = null;
       // }
	   function linkArc(d) {
	     //const r = Math.hypot(d.target.x - d.source.x, d.target.y - d.source.y);
	     const r = 0;
	     return `
		       M${d.source.x},${d.source.y}
		       A${r},${r} 0 0,1 ${d.target.x},${d.target.y}
		     `;
	   }
   </script>
